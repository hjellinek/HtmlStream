(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)

(FILECREATED "19-Nov-2024 11:56:13" {DSK}<Users>hjellinek>Projects>TrySVG>Lisp>XCCS-UNICODE-DUMPER.;9 9496   

      :CHANGES-TO (FNS PROCESS-BROWSER-FONT-METRICS)
                  (VARS XCCS-UNICODE-DUMPERCOMS)

      :PREVIOUS-DATE "12-Nov-2024 16:49:40" 
{DSK}<Users>hjellinek>Projects>TrySVG>Lisp>XCCS-UNICODE-DUMPER.;6)


(PRETTYCOMPRINT XCCS-UNICODE-DUMPERCOMS)

(RPAQQ XCCS-UNICODE-DUMPERCOMS ((FILES HTMLSTREAM)
                                (FUNCTIONS CREATE-ALL-FONT-METRICS)
                                (FNS PROCESS-BROWSER-FONT-METRICS)
                                (FUNCTIONS DUMP-XCCS-UNICODE-MAPPING WRITE-FONT-METRICS-FILE 
                                       WRITE-CHARSET-METRICS-FILE)
                                (RECORDS WEB-FONT-DESCR WEB-FONT-FACE)))

(FILESLOAD HTMLSTREAM)

(CL:DEFUN CREATE-ALL-FONT-METRICS (&KEY (DATA-DIR *WEB-FONT-DIRECTORY*)
                                        (DATA-FILE-NAME *DEFAULT-WEB-FONT-METRICS-FILE-NAME*)
                                        (OUTPUT-DIR *WEB-FONT-DIRECTORY*))
   "Process all Web fonts and create metrics files"
   (LET ((METRICS-DATA-FILE (PACKFILENAME.STRING 'DIRECTORY DATA-DIR 'NAME DATA-FILE-NAME)))
        (CL:FORMAT T "Will read from ~A and write to ~A~%%" METRICS-DATA-FILE OUTPUT-DIR)
        (PROCESS-BROWSER-FONT-METRICS METRICS-DATA-FILE OUTPUT-DIR)))
(DEFINEQ

(PROCESS-BROWSER-FONT-METRICS
  [LAMBDA (METRICS-DATA-FILE-NAME OUTPUT-DIR)

    (* ;; 
  "Read a series of font metrics from the metrics file and translate them into individual .wfm files")

    (* ;; "The file name looks like <family>-<size>-<weight>-<slope>-<expansion>.wfm")

    (* ;; "For example, ROBOTO-MONO-10-REGULAR-REGULAR-REGULAR.wfm")

    (CL:WITH-OPEN-STREAM [IN (OPENSTREAM METRICS-DATA-FILE-NAME 'INPUT NIL '((FORMAT :THROUGH]

           (* ;; "read and check the version, then read the TOC")

           (LET ((VERSION (CHECK-BROWSER-METRICS-FORMAT (READ IN)))
                 (TOC (READ IN)))
                (while (SKIPSEPRS IN)
                   do (LET* ((FONT-MEASUREMENT (READ IN))
                             (FONT-FAMILY (fetch (WEB-FONT-METRICS family) of FONT-MEASUREMENT))
                             (FONT-SIZE (fetch (WEB-FONT-METRICS size) of FONT-MEASUREMENT))
                             (FONT-WEIGHT (fetch (WEB-FONT-METRICS weight) of FONT-MEASUREMENT))
                             (FONT-STYLE (fetch (WEB-FONT-METRICS style) of FONT-MEASUREMENT))
                             (CHARSETS (fetch (WEB-FONT-METRICS charsets) of FONT-MEASUREMENT))
                             (LINE-HEIGHT (COMPUTE-LINE-HEIGHT CHARSETS))
                             (MAX-ASCENT (COMPUTE-MAX-ASCENT CHARSETS))
                             (MAX-DESCENT (COMPUTE-MAX-DESCENT CHARSETS))
                             (FONT-LISP-NAME (MKATOM (fetch (WEB-FONT-METRICS lispName) of 
                                                                                     FONT-MEASUREMENT
                                                            )))
                             (FONT-LISP-FACE (MAPCAR (fetch (WEB-FONT-METRICS lispFace) of 
                                                                                     FONT-MEASUREMENT
                                                            )
                                                    #'MKATOM))
                             (FONT-LISP-SIZE (fetch (WEB-FONT-METRICS lispSize) of FONT-MEASUREMENT))
                             )
                            (CL:FORMAT T 
                                "Font ~s, ~A ~A ~A: height ~d, ascent ~d, descent ~d, ~d charsets~%%"
                                   FONT-FAMILY FONT-SIZE FONT-WEIGHT FONT-STYLE (CP-TO-P LINE-HEIGHT)
                                   (CP-TO-P MAX-ASCENT)
                                   (CP-TO-P MAX-DESCENT)
                                   (LENGTH CHARSETS))

                            (* ;; "write a wfm file to describe the font itself")

                            (WRITE-FONT-METRICS-FILE OUTPUT-DIR FONT-LISP-NAME FONT-LISP-FACE 
                                   FONT-LISP-SIZE LINE-HEIGHT CHARSETS MAX-ASCENT MAX-DESCENT)
                            (for CHARSET in CHARSETS do 
                                                        (* ;; 
                                          "write each charset's metrics as a set of standalone files")

                                                        (WRITE-CHARSET-METRICS-FILE OUTPUT-DIR 
                                                               FONT-LISP-NAME FONT-LISP-SIZE 
                                                               FONT-LISP-FACE CHARSET])
)

(CL:DEFUN DUMP-XCCS-UNICODE-MAPPING ()                       (* ; "Edited  2-Sep-2024 16:23 by hdj")
                                                             (* ; "Edited 30-Aug-2024 12:24 by hdj")

   (* ;; "Dump the mapping from XCCS to Unicode character codes as JSON")
                                                             (* ; "Edited 29-Aug-2024 15:30 by hdj")
   (CL:WITH-OPEN-STREAM [OUT (OPENSTREAM "Unicode_to_XCCS.js" 'OUTPUT NIL '((FORMAT :THROUGH]
          (LINELENGTH T OUT)
          (CL:FORMAT OUT "// use a short temp variable name!~%%")
          (CL:FORMAT OUT "const t = [];~%%")
          (LET ((NUM-MAPPINGS 0)
                (MAX-XCCS 0))
               [for U from 32 to 65535 do (LET [(IN-XCCS (CONDITIONS:HANDLER-CASE (UTOXCODE U)
                                                                (INTERLISP-ERROR (E)
                                                                       NIL]
                                               (CL:IF IN-XCCS
                                                   (PROGN (CL:FORMAT OUT "t[~D]=~D;~%%" U IN-XCCS)
                                                          (CL:INCF NUM-MAPPINGS)
                                                          (SETQ MAX-XCCS (MAX MAX-XCCS IN-XCCS))))]
               (CL:FORMAT OUT "const xccs_to_unicode = t;~%%")
               (CL:FORMAT OUT "const max_xccs = ~d;~%%" MAX-XCCS)
               (CL:FORMAT OUT "const num_mappings = ~D;~%%" NUM-MAPPINGS))))

(CL:DEFUN WRITE-FONT-METRICS-FILE (OUTPUT-DIR FAMILY FACE SIZE HEIGHT CHARSETS MAX-ASCENT MAX-DESCENT
                                         )
   "Write a description of the font"

   (* ;; "The file name looks like <family>-<size>-<weight>-<slope>-<expansion>.wfm")

   (* ;; "For example, ROBOTO-MONO-10-MEDIUM-REGULAR-REGULAR.wfm")

   [LET* [(WEIGHT (fetch (WEB-FONT-FACE weight) of FACE))
          (SLOPE (fetch (WEB-FONT-FACE slope) of FACE))
          (EXPANSION (fetch (WEB-FONT-FACE expansion) of FACE))
          (FILE-NAME (CL:MAKE-PATHNAME :DIRECTORY OUTPUT-DIR :NAME (MAKE-FONT-METRICS-FILE-NAME
                                                                    FAMILY SIZE WEIGHT SLOPE 
                                                                    EXPANSION]
         (CL:WITH-OPEN-STREAM (OUT (OPENSTREAM FILE-NAME 'OUTPUT 'NEW))
                (PRINT (LIST 'format *BROWSER-FONT-FILE-VERSION*)
                       OUT)
                (PRINT (create WEB-FONT-DESCR
                              name _ FAMILY
                              face _ FACE
                              size _ SIZE
                              height _ HEIGHT
                              maxAscent _ MAX-ASCENT
                              maxDescent _ MAX-DESCENT
                              charsets _ (LENGTH CHARSETS))
                       OUT)
                (AND NIL (CL:FORMAT T "Wrote font file ~A~%%" FILE-NAME])

(CL:DEFUN WRITE-CHARSET-METRICS-FILE (OUTPUT-DIR FAMILY SIZE FACE CHARSET)
   "Write a file containing a charset's metrics"

   (* ;; "The file name looks like <family>-<size>-<weight>-<slope>-<expansion>-<charset>.wcm")

   (* ;; "For example, ROBOTO-MONO-10-REGULAR-REGULAR-REGULAR-0.wcm")

   [LET* [(WEIGHT (fetch (WEB-FONT-FACE weight) of FACE))
          (SLOPE (fetch (WEB-FONT-FACE slope) of FACE))
          (EXPANSION (fetch (WEB-FONT-FACE expansion) of FACE))
          (CHARSET-NUM (fetch (WEB-CHARSET-METRICS charset) of CHARSET))
          (HEIGHT (fetch (WEB-CHARSET-METRICS height) of CHARSET))
          (MAX-ASCENT (fetch (WEB-CHARSET-METRICS maxAscent) of CHARSET))
          (MAX-DESCENT (fetch (WEB-CHARSET-METRICS maxDescent) of CHARSET))
          (WIDTHS (fetch (WEB-CHARSET-METRICS xccsWidths) of CHARSET))
          (FILE-NAME (CL:MAKE-PATHNAME :DIRECTORY OUTPUT-DIR :NAME
                            (MAKE-CHARSET-METRICS-FILE-NAME FAMILY SIZE WEIGHT SLOPE EXPANSION 
                                   CHARSET-NUM]
         (CL:WITH-OPEN-STREAM (OUT (OPENSTREAM FILE-NAME 'OUTPUT 'NEW))
                (PRINT (LIST 'format *BROWSER-FONT-FILE-VERSION*)
                       OUT)
                (PRINT CHARSET OUT)
                (AND NIL (CL:FORMAT T "Wrote charset ~A~%%" FILE-NAME])
(DECLARE%: EVAL@COMPILE

(PROPRECORD WEB-FONT-DESCR (name face size height maxAscent maxDescent charsets))

(RECORD WEB-FONT-FACE (weight slope expansion))
)
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (898 1451 (CREATE-ALL-FONT-METRICS 898 . 1451)) (1452 4903 (PROCESS-BROWSER-FONT-METRICS
 1462 . 4901)) (4905 6431 (DUMP-XCCS-UNICODE-MAPPING 4905 . 6431)) (6433 7913 (WRITE-FONT-METRICS-FILE
 6433 . 7913)) (7915 9307 (WRITE-CHARSET-METRICS-FILE 7915 . 9307)))))
STOP
