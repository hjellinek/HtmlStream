(DEFINE-FILE-INFO PACKAGE "INTERLISP" READTABLE "INTERLISP" BASE 10)

(FILECREATED "17-Oct-2024 15:30:47" {DSK}<Users>hjellinek>Projects>TrySVG>Lisp>HTMLSTREAM.;49 32057  

      :CHANGES-TO (FUNCTIONS HTML.WRITE-PREFACE HTML.TERPRI \HTML.END-PAGE \HTML.MAYBE-START-PAGE 
                         HTML.INCHES-TO-POINTS HTML.OUTPUT-TEXT \HTML.LINEHEIGHT HTML.DRAWELLIPSE 
                         HTML.DRAWLINE HTML.DRAWPOLYGON HTML.FILLPOLYGON HTML.RESET \HTML.FILLCIRCLE
                         \HTML.SVG-Y HTML.YPOSITION \HTML.INIT-IMAGEDATA OPENHTMLSTREAM 
                         \HTMLSTREAM.INIT \HTML.FONTSAVAILABLE \HTML.FONTCREATE MAKE-HTML-IMAGETYPE 
                         HTML.DRAWCIRCLE HTML.OUTCHARFN HTML.FILLCIRCLE HTML.CHARWIDTH HTML.CLOSEFN 
                         HTML.MOVETO \HTML.CHARWIDTH HTML.OUTPUT-GRAPHICS CHECK-OPEN HTML.BACKCOLOR 
                         HTML.BOTTOMMARGIN HTML.CLIPPINGREGION HTML.COLOR HTML.FONT HTML.LEFTMARGIN 
                         HTML.LINEFEED HTML.OPERATION HTML.RIGHTMARGIN HTML.SCALE HTML.SPACEFACTOR 
                         HTML.TOPMARGIN HTML.XPOSITION with-htmldata HTML.DRAWCURVE)
                  (VARS HTMLSTREAMCOMS)
                  (VARIABLES HTML.STATES HTML.STATE.BETWEEN-PAGES *HTML.DEFAULT-PAGE-SIZE* 
                         \HTMLSTREAM.FDEV HTML.STATE.NON-TEXT HTML.STATE.NON-TEXT-OUTPUT)
                  (STRUCTURES HTML.IMAGEDATA HTML.IMAGEDATA2 IMAGEDATA)
                  (RECORDS HTML.IMAGEDATA)
                  (FNS HTML.OUTPUT-GRAPHICS)

      :PREVIOUS-DATE " 3-Oct-2024 14:59:15" {DSK}<Users>hjellinek>Projects>TrySVG>Lisp>HTMLSTREAM.;13
)


(PRETTYCOMPRINT HTMLSTREAMCOMS)

(RPAQQ HTMLSTREAMCOMS
       ((VARIABLES *HTML.DEFAULT-PAGE-SIZE* HTML.FONTCREATE.DEVICENAME HTML.IMAGETYPE 
               HTML.STATE.BETWEEN-PAGES HTML.STATE.CLOSED HTML.STATE.NON-TEXT 
               HTML.STATE.NON-TEXT-OUTPUT HTML.STATE.TEXT-OUTPUT HTML.STATES \HTMLSTREAM.FDEV)
        (FUNCTIONS CHECK-OPEN HTML.BACKCOLOR HTML.BITBLT HTML.BLTSHADE HTML.BOTTOMMARGIN 
               HTML.CHARWIDTH HTML.CLIPPINGREGION HTML.CLOSEFN HTML.COLOR HTML.DRAWCIRCLE 
               HTML.DRAWCURVE HTML.DRAWELLIPSE HTML.DRAWLINE HTML.DRAWPOLYGON HTML.FILLCIRCLE 
               HTML.FILLPOLYGON HTML.FONT HTML.INCHES-TO-POINTS HTML.LEFTMARGIN HTML.LINEFEED 
               HTML.MOVETO HTML.NEWPAGE HTML.OPERATION HTML.OUTCHARFN HTML.OUTPUT-GRAPHICS 
               HTML.OUTPUT-TEXT HTML.RESET HTML.RIGHTMARGIN HTML.SCALE HTML.SCALEDBITBLT 
               HTML.SPACEFACTOR HTML.STRINGWIDTH HTML.TERPRI HTML.TOPMARGIN HTML.WRITE-PREFACE 
               HTML.XPOSITION HTML.YPOSITION MAKE-HTML-IMAGETYPE OPENHTMLSTREAM \HTML.CHARWIDTH 
               \HTML.END-PAGE \HTML.FILLCIRCLE \HTML.FONTCREATE \HTML.FONTSAVAILABLE 
               \HTML.INIT-IMAGEDATA \HTML.LINEHEIGHT \HTML.SVG-Y \HTML.MAYBE-START-PAGE 
               \HTMLSTREAM.INIT with-htmldata)
        (STRUCTURES HTML.IMAGEDATA)))

(CL:DEFCONSTANT *HTML.DEFAULT-PAGE-SIZE*

   (* ;; "the default size of an HTML page, in points")

   (CONS (HTML.INCHES-TO-POINTS 8.5)
         (HTML.INCHES-TO-POINTS 11.0)))

(CL:DEFCONSTANT HTML.FONTCREATE.DEVICENAME 'HTML)

(CL:DEFCONSTANT HTML.IMAGETYPE 'HTML)

(CL:DEFCONSTANT HTML.STATE.BETWEEN-PAGES :HTML.STATE.BETWEEN-PAGES)

(CL:DEFCONSTANT HTML.STATE.CLOSED :HTML.STATE.CLOSED)

(CL:DEFCONSTANT HTML.STATE.NON-TEXT :HTML.STATE.NON-TEXT)

(CL:DEFCONSTANT HTML.STATE.NON-TEXT-OUTPUT :HTML.STATE.NON-TEXT-OUTPUT)

(CL:DEFCONSTANT HTML.STATE.TEXT-OUTPUT :HTML.STATE.TEXT-OUTPUT)

(CL:DEFCONSTANT HTML.STATES '(HTML.STATE.BETWEEN-PAGES HTML.STATE.NON-TEXT-OUTPUT 
                                    HTML.STATE.TEXT-OUTPUT HTML.STATE.CLOSED)
                            "All HTML imagestream states, for informational use.")

(DEFGLOBALVAR \HTMLSTREAM.FDEV "The FDEV for HTML output")

(DEFMACRO CHECK-OPEN (STREAM)
   `[with-htmldata (DATA ,STREAM)
           (COND
              ((EQ (\HTML-STATE DATA)
                   HTML.STATE.CLOSED)
               (ERROR "HTMLSTREAM is in state CLOSED"])

(CL:DEFUN HTML.BACKCOLOR (STREAM NEW-COLOR)
   (printout T "HTML.BACKCOLOR" T)
   (CHECK-OPEN STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-BG-COLOR DATA)))
               (COND
                  (NEW-COLOR (CL:SETF (\HTML-BG-COLOR DATA)
                                    NEW-COLOR)))
               OLD-VALUE)))

(CL:DEFUN HTML.BITBLT (SOURCEBITMAP SOURCELEFFT SOURCEBOTTOM STREAM DESTINATIONLEFT DESTINATIONBOTTOM
                             WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE CLIPPINGREGION 
                             CLIPPEDSOURCELEFT CLIPPEDSOURCEBOTTOM)
   (printout T "HTML.BITBLT" T))

(CL:DEFUN HTML.BLTSHADE (TEXTURE STREAM DESTINATIONLEFT DESTINATIONBOTTOM WIDTH HEIGHT OPERATION 
                               CLIPPINGREGION)
   (printout T "HTML.BLTSHADE" T))

(CL:DEFUN HTML.BOTTOMMARGIN (STREAM NEW-BOTTOM-MARGIN)
   (printout T "HTML.BOTTOMMARGIN")
   (CHECK-OPEN STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-BOTTOM-MARGIN DATA)))
               (if NEW-BOTTOM-MARGIN
                   then (CL:SETF (\HTML-BOTTOM-MARGIN DATA)
                               NEW-BOTTOM-MARGIN))
               OLD-VALUE)))

(CL:DEFUN HTML.CHARWIDTH (STREAM CHARCODE)

   (* ;; "TODO phony value")

   10)

(CL:DEFUN HTML.CLIPPINGREGION (STREAM NEW-REGION)
   (printout T "HTML.CLIPPINGREGION")
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-CLIPPING-REGION DATA)))
               (COND
                  (NEW-REGION (CL:SETF (\HTML-CLIPPING-REGION DATA)
                                     NEW-REGION)))
               OLD-VALUE)))

(CL:DEFUN HTML.CLOSEFN (STREAM)
   (printout T "HTML.CLOSEFN" T)
   (with-htmldata (DATA STREAM)
          (LET ((BACKING (\HTML-BACKING-STREAM DATA)))

               (* ;; " TODO close any open sections (e.g., text)")

               (if (EQ (\HTML-STATE DATA)
                       HTML.STATE.TEXT-OUTPUT)
                   then (HTML.OUTPUT-GRAPHICS STREAM))
               (printout BACKING T "</svg>" T "</body>" T "</html>" T)
               (CLOSEF BACKING)
               (CL:SETF (\HTML-STATE DATA)
                      HTML.STATE.CLOSED))))

(CL:DEFUN HTML.COLOR (STREAM NEW-COLOR)
   (printout T "HTML.COLOR")
   (CHECK-OPEN STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-FG-COLOR DATA)))
               (COND
                  (NEW-COLOR (CL:SETF (\HTML-FG-COLOR DATA)
                                    NEW-COLOR)))
               OLD-VALUE)))

(CL:DEFUN HTML.DRAWCIRCLE (STREAM CENTERX CENTERY RADIUS BRUSH DASHING)
   "Draw a circle"

   (* ;; "TODO implement BRUSH and DASHING")

   (\HTML.FILLCIRCLE STREAM CENTERX CENTERY RADIUS "transparent"))

(CL:DEFUN HTML.DRAWCURVE (STREAM KNOTS CLOSED BRUSH DASHING)
   (printout T "HTML.DRAWCURVE" T))

(CL:DEFUN HTML.DRAWELLIPSE (STREAM CENTERX CENTERY SEMIMINORRADIUS SEMIMAJORRADIUS ORIENTATION BRUSH
                                  DASHING)
   "Draw an ellipse"

   (* ;; "TODO implement BRUSH and DASHING")

   [with-htmldata (DATA STREAM)
          (HTML.OUTPUT-GRAPHICS STREAM)
          (LET ((BACKING (\HTML-BACKING-STREAM DATA)))
               (CL:FORMAT BACKING "<ellipse cx=%"~d%" cy=%"~d%" rx=%"~d%" ry=%"~d%" transform=%"rotate(~d,~d,~d)%" fill=%"transparent%" stroke=%"black%" stroke-width=%"1%"/>~%%"
                      CENTERX (\HTML.SVG-Y DATA CENTERY)
                      SEMIMAJORRADIUS SEMIMINORRADIUS (- ORIENTATION)
                      CENTERX
                      (\HTML.SVG-Y DATA CENTERY])

(CL:DEFUN HTML.DRAWLINE (STREAM X1 Y1 X2 Y2 WIDTH OPERATION COLOR)
   "Draw a line"

   (* ;; "TODO implement OPERATION and COLOR")

   (with-htmldata (DATA STREAM)
          (HTML.OUTPUT-GRAPHICS STREAM)
          (LET ((BACKING (\HTML-BACKING-STREAM DATA)))
               (CL:FORMAT BACKING 
            "<line x1=%"~d%" y1=%"~d%" x2=%"~d%" y2=%"~d%" stroke=%"black%" stroke-width=%"~d%"/>~%%"
                      X1 (\HTML.SVG-Y DATA Y1)
                      X2
                      (\HTML.SVG-Y DATA Y2)
                      (OR WIDTH 1)))
          (HTML.MOVETO STREAM X2 Y2)))

(CL:DEFUN HTML.DRAWPOLYGON (STREAM POINTS CLOSED BRUSH DASHING)
   "Draw an open or closed polygon"

   (* ;; "TODO implement BRUSH and DASHING")

   (CHECK-OPEN STREAM)
   (HTML.OUTPUT-GRAPHICS STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((BACKING (\HTML-BACKING-STREAM DATA))
                (DRAWING-TYPE (if CLOSED
                                  then "polygon"
                                else "polyline")))
               (CL:FORMAT BACKING "<~a fill=%"none%" stroke=%"black%" stroke-width=%"1%" points=%"" 
                      DRAWING-TYPE)
               [for POINT in POINTS do (CL:FORMAT BACKING "~d,~d " (CAR POINT)
                                              (\HTML.SVG-Y DATA (CDR POINT]
               (CL:FORMAT BACKING "%"/>~%%"))))

(CL:DEFUN HTML.FILLCIRCLE (STREAM CENTERX CENTERY RADIUS TEXTURE)

   (* ;; "TODO implement TEXTURE")

   (\HTML.FILLCIRCLE STREAM CENTERX CENTERY RADIUS "black"))

(CL:DEFUN HTML.FILLPOLYGON (STREAM POINTS TEXTURE)
   "Fill a closed polygon"

   (* ;; "TODO implement TEXTURE")

   (CHECK-OPEN STREAM)
   (HTML.OUTPUT-GRAPHICS STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((BACKING (\HTML-BACKING-STREAM DATA)))
               (CL:FORMAT BACKING 
        "<polygon fill=%"black%" fill-rule=%"evenodd%" stroke=%"black%" stroke-width=%"1%" points=%""
                      )
               [for POINT in POINTS do (CL:FORMAT BACKING "~d,~d " (CAR POINT)
                                              (\HTML.SVG-Y DATA (CDR POINT]
               (CL:FORMAT BACKING "%"/>~%%"))))

(CL:DEFUN HTML.FONT (STREAM NEW-FONT)
   (printout T "HTML.FONT" T)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-FONT DATA)))
               (COND
                  (NEW-FONT (CL:SETF (\HTML-FONT DATA)
                                   NEW-FONT)))
               OLD-VALUE)))

(CL:DEFUN HTML.INCHES-TO-POINTS (INCHES)
   "Convert inches to points"

   (* ;; "Assume one inch contains 72 points")

   (FIXR (TIMES 72 INCHES)))

(CL:DEFUN HTML.LEFTMARGIN (STREAM NEW-LEFT-MARGIN)
   (printout T "HTML.LEFTMARGIN" T)
   (CHECK-OPEN STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-LEFT-MARGIN DATA)))
               (COND
                  (NEW-LEFT-MARGIN (CL:SETF (\HTML-LEFT-MARGIN DATA)
                                          NEW-LEFT-MARGIN)))
               OLD-VALUE)))

(CL:DEFUN HTML.LINEFEED (STREAM NEW-DELTA)
   (printout T "HTML.LINEFEED" T)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-LINEFEED DATA)))
               (COND
                  (NEW-DELTA (CL:SETF (\HTML-LINEFEED DATA)
                                    NEW-DELTA)))
               OLD-VALUE)))

(CL:DEFUN HTML.MOVETO (STREAM X Y)
   "Move to X, Y"
   (printout T "HTML.MOVETO" T)
   (HTML.OUTPUT-GRAPHICS STREAM)
   (with-htmldata (DATA STREAM)
          (CL:SETF (\HTML-X-POSITION DATA)
                 X)
          (CL:SETF (\HTML-Y-POSITION DATA)
                 Y)))

(CL:DEFUN HTML.NEWPAGE (STREAM)
   (printout T "HTML.NEWPAGE" T))

(CL:DEFUN HTML.OPERATION (STREAM NEW-OPERATION)
   (printout T "HTML.OPERATION" T)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-IMAGE-OPERATION DATA)))
               (COND
                  (NEW-OPERATION (CL:SETF (\HTML-IMAGE-OPERATION DATA)
                                        NEW-OPERATION)))
               OLD-VALUE)))

(CL:DEFUN HTML.OUTCHARFN (STREAM CHCODE)
   "Write a character, which may cause us to write other markup first"
   (CHECK-OPEN STREAM)
   [with-htmldata (DATA STREAM)
          (LET ((BACKING (\HTML-BACKING-STREAM DATA)))
               (\HTML.MAYBE-START-PAGE DATA STREAM)
               (if (NEQ (\HTML-STATE DATA)
                        HTML.STATE.TEXT-OUTPUT)
                   then (HTML.OUTPUT-TEXT STREAM))
               (SELECTC CHCODE
                   ((CHARCODE ^J)                            (* ; "handle LF")
                        (HTML.TERPRI STREAM))
                   ((CHARCODE ^M)                            (* ; "handle CR")
                        (HTML.TERPRI STREAM))
                   ((CHARCODE ^L)                            (* ; "handle pagefeed")
                        (HTML.NEWPAGE STREAM))
                   (LET* ((CHAR-WIDTH (\HTML.CHARWIDTH STREAM CHCODE))
                          (NEW-X-POSITION (+ (\HTML-X-POSITION DATA)
                                             CHAR-WIDTH)))
                         (if (> NEW-X-POSITION (\HTML-RIGHT-MARGIN DATA))
                             then (HTML.TERPRI STREAM))
                         (\OUTCHAR BACKING CHCODE)
                         (CL:INCF (\HTML-X-POSITION DATA)
                                (HTML.CHARWIDTH STREAM CHCODE])

(CL:DEFUN HTML.OUTPUT-GRAPHICS (STREAM)
   "We're going to do some graphics now"
   (with-htmldata (DATA STREAM)
          (SELECTC (\HTML-STATE DATA)
              (HTML.STATE.NON-TEXT-OUTPUT                    (* ; "this is the state we need")
                   )
              (HTML.STATE.TEXT-OUTPUT                        (* ; "end the text section")
                   (printout (\HTML-BACKING-STREAM DATA)
                          "</text>" T))
              NIL)

          (* ;; "finally")

          (CL:SETF (\HTML-STATE DATA)
                 HTML.STATE.NON-TEXT-OUTPUT)))

(CL:DEFUN HTML.OUTPUT-TEXT (STREAM)
   "We're being asked to write text"
   (with-htmldata (DATA STREAM)
          (SELECTC (\HTML-STATE DATA)
              (HTML.STATE.NON-TEXT-OUTPUT                    (* ; "start a new text section")
                   (printout (\HTML-BACKING-STREAM DATA)
                          "<text x="
                          (\HTML-X-POSITION DATA)
                          " y="
                          (\HTML.SVG-Y DATA (- (\HTML-Y-POSITION DATA)
                                               (\HTML.LINEHEIGHT STREAM)))
                          ">" T))
              (HTML.STATE.TEXT-OUTPUT                        (* ; "continue this text section")
                   )
              NIL)

          (* ;; "finally")

          (CL:SETF (\HTML-STATE DATA)
                 HTML.STATE.TEXT-OUTPUT)))

(CL:DEFUN HTML.RESET (STREAM)
   (printout T "HTML.RESET" T)
   (with-htmldata (DATA STREAM)
          (CL:SETF (\HTML-X-POSITION DATA)
                 (\HTML-LEFT-MARGIN DATA))
          (CL:SETF (\HTML-Y-POSITION DATA)
                 (\HTML-BOTTOM-MARGIN DATA))
          (CL:SETF (\HTML-STATE DATA)
                 HTML.STATE.NON-TEXT)))

(CL:DEFUN HTML.RIGHTMARGIN (STREAM NEW-RIGHT-MARGIN)
   (printout T "HTML.RIGHTMARGIN" T)
   (CHECK-OPEN STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-RIGHT-MARGIN DATA)))
               (COND
                  (NEW-RIGHT-MARGIN (CL:SETF (\HTML-RIGHT-MARGIN DATA)
                                           NEW-RIGHT-MARGIN)))
               OLD-VALUE)))

(CL:DEFUN HTML.SCALE (STREAM NEW-SCALE)
   (printout T "HTML.SCALE" T)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-SCALE DATA)))
               (COND
                  (NEW-SCALE (CL:SETF (\HTML-SCALE DATA)
                                    NEW-SCALE)))
               OLD-VALUE)))

(CL:DEFUN HTML.SCALEDBITBLT (SOURCEBITMAP SOURCELEFFT SOURCEBOTTOM STREAM DESTINATIONLEFT 
                                   DESTINATIONBOTTOM WIDTH HEIGHT SOURCETYPE OPERATION TEXTURE 
                                   CLIPPINGREGION CLIPPEDSOURCELEFT CLIPPEDSOURCEBOTTOM SCALE)
   (printout T "HTML.SCALEDBITBLT" T))

(CL:DEFUN HTML.SPACEFACTOR (STREAM NEW-FACTOR)
   (printout T "HTML.SPACEFACTOR" T)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-SPACE-FACTOR DATA)))
               (COND
                  (NEW-FACTOR (CL:SETF (\HTML-SPACE-FACTOR DATA)
                                     NEW-FACTOR)))
               OLD-VALUE)))

(CL:DEFUN HTML.STRINGWIDTH (STREAM STR RDTBL)
   (printout T "HTML.STRINGWIDTH" T)
   0)

(CL:DEFUN HTML.TERPRI (STREAM)
   "Do a newline"
   (printout T "HTML.TERPRI" T)
   (CHECK-OPEN STREAM)
   (HTML.OUTPUT-GRAPHICS STREAM)
   [with-htmldata (DATA STREAM)
          (LET ((BACKING (\HTML-BACKING-STREAM DATA)))
               (CL:SETF (\HTML-X-POSITION DATA)
                      (\HTML-LEFT-MARGIN DATA))

               (* ;; "check to see if Y-POSITION overflowed BOTTOM-MARGIN and start a new page if so")

               (CL:DECF (\HTML-Y-POSITION DATA)
                      (\HTML-LINEFEED DATA))
               (if (< (\HTML-Y-POSITION DATA)
                      (\HTML-BOTTOM-MARGIN DATA))
                   then (\HTML.MAYBE-START-PAGE DATA STREAM)
                 else (HTML.OUTPUT-TEXT STREAM])

(CL:DEFUN HTML.TOPMARGIN (STREAM NEW-TOP-MARGIN)
   (printout T "HTML.TOPMARGIN" T)
   (CHECK-OPEN STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-TOP-MARGIN DATA)))
               (COND
                  (NEW-TOP-MARGIN (CL:SETF (\HTML-TOP-MARGIN DATA)
                                         NEW-TOP-MARGIN)))
               OLD-VALUE)))

(CL:DEFUN HTML.WRITE-PREFACE (STREAM)
   "Write the preamble to the file: <html><head>... etc."
   (with-htmldata (DATA STREAM)
          (LET ((BACKING (\HTML-BACKING-STREAM DATA))
                (TITLE (\HTML-TITLE DATA)))
               (printout BACKING "<!DOCTYPE HTML>" T)
               (printout BACKING "<html>" T)
               (printout BACKING "<head>" T)
               (printout BACKING "<title>" TITLE "</title>" T)
               (printout BACKING "<link rel=%"preconnect%" href=%"https://fonts.googleapis.com%">" T)
               (printout BACKING 
                      "<link rel=%"preconnect%" href=%"https://fonts.gstatic.com%" crossorigin>" T)
               (printout BACKING "<link href=%"https://fonts.googleapis.com/css2?family=Noto+Sans+Display&family=Roboto&family=Roboto+Mono&display=swap%" rel=%"stylesheet%">"
                      T)
               (printout BACKING "<script>" T)
               (printout BACKING "    const fontSpecs = [" T)
               (printout BACKING "            {family: %"Roboto Mono%", size: %"10pt%"}," T)
               (printout BACKING "            {family: %"Noto Sans Display%", size: %"10pt%"}," T)
               (printout BACKING "            {family: %"Roboto%", size: %"10pt%"}," T)
               (printout BACKING "            {family: %"Roboto Mono%", size: %"20pt%"}," T)
               (printout BACKING "            {family: %"Noto Sans Display%", size: %"20pt%"}," T)
               (printout BACKING "            {family: %"Roboto%", size: %"20pt%"}," T)
               (printout BACKING "    ];" T T)
               (printout BACKING "    function fontFromSpec(font) {" T 
                      "        return font.size + %" %" + font.family;" T "    }" T T)
               (printout BACKING "    const fontLoadPromises = [];" T T)
               (printout BACKING "    for (const spec of fontSpecs) {" T 
                      "        fontLoadPromises.push(document.fonts.load(fontFromSpec(spec)));" T 
                      "    }" T T)
               (printout BACKING 
                  "    Promise.all(fontLoadPromises).then(_ => { console.log('All fonts loaded');});"
                      T)
               (printout BACKING "</script>" T)
               (printout BACKING "<style>" T)
               (printout BACKING ".nsd10 { font-family: 'Noto Sans Display'; font-size: 10pt }" T)
               (printout BACKING ".nsd20 { font-family: 'Noto Sans Display'; font-size: 20pt }" T)
               (printout BACKING ".nsd30 { font-family: 'Noto Sans Display'; font-size: 30pt }" T)
               (printout BACKING ".nsd40 { font-family: 'Noto Sans Display'; font-size: 4s0pt }" T)
               (printout BACKING ".rm10 { font-family: 'Roboto Mono'; font-size: 10pt }" T)
               (printout BACKING ".rm20 { font-family: 'Roboto Mono'; font-size: 20pt }" T)
               (printout BACKING ".rm30 { font-family: 'Roboto Mono'; font-size: 30pt }" T)
               (printout BACKING ".rm40 { font-family: 'Roboto Mono'; font-size: 4s0pt }" T)
               (printout BACKING ".r10 { font-family: 'Roboto'; font-size: 10pt }" T)
               (printout BACKING ".r20 { font-family: 'Roboto'; font-size: 20pt }" T)
               (printout BACKING ".r30 { font-family: 'Roboto'; font-size: 30pt }" T)
               (printout BACKING ".r40 { font-family: 'Roboto'; font-size: 4s0pt }" T)
               (printout BACKING "</style>" T)
               (printout BACKING "</head>" T)
               (printout BACKING "<body>" T)
               BACKING)))

(CL:DEFUN HTML.XPOSITION (STREAM NEW-X-POSITION)
   (printout T "HTML.XPOSITION" T)
   (CHECK-OPEN STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-X-POSITION DATA)))
               (COND
                  (NEW-X-POSITION (CL:SETF (\HTML-X-POSITION DATA)
                                         NEW-X-POSITION)))
               OLD-VALUE)))

(CL:DEFUN HTML.YPOSITION (STREAM NEW-Y-POSITION)
   (CHECK-OPEN STREAM)
   (with-htmldata (DATA STREAM)
          (LET ((OLD-VALUE (\HTML-Y-POSITION DATA)))
               (COND
                  (NEW-Y-POSITION (CL:SETF (\HTML-Y-POSITION DATA)
                                         NEW-Y-POSITION)))
               OLD-VALUE)))

(CL:DEFUN MAKE-HTML-IMAGETYPE ()
   "Return the IMAGETYPE descriptor for HTML streams."

   (* ;; "TODO there's an undocumented CREATECHARSET method we might need to implement")

   `((OPENSTREAM OPENHTMLSTREAM)
     (FONTCREATE \HTML.FONTCREATE)
     (FONTSAVAILABLE \HTML.FONTSAVAILABLE)))

(CL:DEFUN OPENHTMLSTREAM (FILENAME &OPTIONAL OPTIONS)
   "Open and return an HTML imagestream"
   (LET* ((TITLE (OR (LISTGET OPTIONS 'TITLE)
                     FILENAME))
          (REGION (OR (LISTGET OPTIONS 'REGION)
                      *HTML.DEFAULT-PAGE-SIZE*))
          [BACKING (OPENSTREAM FILENAME 'OUTPUT NIL '((FORMAT :UTF-8]
          (IMAGEOPS (create IMAGEOPS))
          (IMAGEDATA (MAKE-HTML.IMAGEDATA :BACKING-STREAM BACKING :TITLE TITLE :PAGE-WIDTH
                            (CAR REGION)
                            :PAGE-HEIGHT
                            (CDR REGION)))
          (HTMLSTREAM (create STREAM
                             FULLFILENAME _ (FULLNAME BACKING)
                             DEVICE _ \HTMLSTREAM.FDEV
                             ACCESS _ 'OUTPUT
                             OUTCHARFN _ #'HTML.OUTCHARFN
                             STRMBOUTFN _ #'\BUFFERED.BOUT   (* ; "is this right?")
                             IMAGEOPS _ IMAGEOPS
                             USERCLOSEABLE _ T
                             USERVISIBLE _ T
                             IMAGEDATA _ IMAGEDATA)))

         (* ;; "Finish initializing the IMAGEDATA")

         (\HTML.INIT-IMAGEDATA HTMLSTREAM)

         (* ;; "Make the backing file invisible")

         (replace (STREAM USERVISIBLE) of BACKING with NIL)

         (* ;; "install our OUTCHARFN. you can't do this in the create.")

         (replace (STREAM OUTCHARFN) of HTMLSTREAM with #'HTML.OUTCHARFN)

         (* ;; "replace (do not smash!) the stream's IMAGEOPS with ours")

         (replace IMAGEOPS of HTMLSTREAM with IMAGEOPS)

         (* ;; "Set the informational fields")

         (replace IMFONTCREATE of IMAGEOPS with HTML.FONTCREATE.DEVICENAME)
         (replace IMAGETYPE of IMAGEOPS with HTML.IMAGETYPE)

         (* ;; "Set the functions")

         (replace IMCLOSEFN of IMAGEOPS with #'HTML.CLOSEFN)
         (replace IMDRAWLINE of IMAGEOPS with #'HTML.DRAWLINE)
         (replace IMDRAWCURVE of IMAGEOPS with #'HTML.DRAWCURVE)
         (replace IMDRAWCIRCLE of IMAGEOPS with #'HTML.DRAWCIRCLE)
         (replace IMDRAWELLIPSE of IMAGEOPS with #'HTML.DRAWELLIPSE)
         (replace IMFILLPOLYGON of IMAGEOPS with #'HTML.FILLPOLYGON)
         (replace IMDRAWPOLYGON of IMAGEOPS with #'HTML.DRAWPOLYGON)
         (replace IMFILLCIRCLE of IMAGEOPS with #'HTML.FILLCIRCLE)
         (replace IMBLTSHADE of IMAGEOPS with #'HTML.BLTSHADE)
         (replace IMBITBLT of IMAGEOPS with #'HTML.BITBLT)
         (replace IMSCALEDBITBLT of IMAGEOPS with #'HTML.SCALEDBITBLT)
         (replace IMMOVETO of IMAGEOPS with #'HTML.MOVETO)
         (replace IMSTRINGWIDTH of IMAGEOPS with #'HTML.STRINGWIDTH)
         (replace IMCHARWIDTH of IMAGEOPS with #'HTML.CHARWIDTH)
         (replace IMNEWPAGE of IMAGEOPS with #'HTML.NEWPAGE)
         (replace IMTERPRI of IMAGEOPS with #'HTML.TERPRI)
         (replace IMRESET of IMAGEOPS with #'HTML.RESET)
         (replace IMCLIPPINGREGION of IMAGEOPS with #'HTML.CLIPPINGREGION)
         (replace IMXPOSITION of IMAGEOPS with #'HTML.XPOSITION)
         (replace IMYPOSITION of IMAGEOPS with #'HTML.YPOSITION)
         (replace IMFONT of IMAGEOPS with #'HTML.FONT)
         (replace IMLEFTMARGIN of IMAGEOPS with #'HTML.LEFTMARGIN)
         (replace IMRIGHTMARGIN of IMAGEOPS with #'HTML.RIGHTMARGIN)
         (replace IMTOPMARGIN of IMAGEOPS with #'HTML.TOPMARGIN)
         (replace IMBOTTOMMARGIN of IMAGEOPS with #'HTML.BOTTOMMARGIN)
         (replace IMLINEFEED of IMAGEOPS with #'HTML.LINEFEED)
         (replace IMSCALE of IMAGEOPS with #'HTML.SCALE)
         (replace IMSPACEFACTOR of IMAGEOPS with #'HTML.SPACEFACTOR)
         (replace IMOPERATION of IMAGEOPS with #'HTML.OPERATION)
         (replace IMBACKCOLOR of IMAGEOPS with #'HTML.BACKCOLOR)
         (replace IMCOLOR of IMAGEOPS with #'HTML.COLOR)

         (* ;; "Maybe implement these later:")

         (replace IMWRITEPIXEL of IMAGEOPS with #'NILL)
         (replace IMROTATE of IMAGEOPS with #'NILL)
         (replace IMDRAWARC of IMAGEOPS with #'NILL)
         (replace IMTRANSLATE of IMAGEOPS with #'NILL)
         (replace IMSCALE2 of IMAGEOPS with #'NILL)
         (replace IMPUSHSTATE of IMAGEOPS with #'NILL)
         (replace IMPOPSTATE of IMAGEOPS with #'NILL)
         (replace IMDEFAULTSTATE of IMAGEOPS with #'NILL)
         (replace IMCHARWIDTHY of IMAGEOPS with #'NILL)
         (replace IMBITMAPSIZE of IMAGEOPS with #'NILL)

         (* ;; "write the preface")

         (HTML.WRITE-PREFACE HTMLSTREAM)

         (* ;; "return the stream")

         HTMLSTREAM))

(CL:DEFUN \HTML.CHARWIDTH (STREAM CHARCODE)
   "Very fast character width accessor"

   (* ;; "TODO hack!")

   10)

(CL:DEFUN \HTML.END-PAGE (DATA STREAM)
   "End the current page"
   (CL:INCF (\HTML-PAGE-NUM DATA))
   (HTML.RESET STREAM)
   (LET ((BACKING (\HTML-BACKING-STREAM DATA)))
        (CL:FORMAT BACKING "</svg>~%%")))

(CL:DEFUN \HTML.FILLCIRCLE (STREAM CENTERX CENTERY RADIUS COLOR-NAME)

   (* ;; "common code underlying HTML.FILLCIRCLE and HTML.DRAWCIRCLE")

   (with-htmldata (DATA STREAM)
          (HTML.OUTPUT-GRAPHICS STREAM)
          (LET ((BACKING (\HTML-BACKING-STREAM DATA)))
               (CL:FORMAT BACKING 
          "<circle cx=%"~d%" cy=%"~d%" r=%"~d%" fill=%"~a%" stroke=%"black%" stroke-width=%"1%"/>~%%"
                      CENTERX (\HTML.SVG-Y DATA CENTERY)
                      RADIUS COLOR-NAME))
          (HTML.MOVETO STREAM CENTERX CENTERY)))

(CL:DEFUN \HTML.FONTCREATE (FAMILY SIZE FACE ROTATION DEVICE)
   "Create a font for the HTML device"
   (CL:FORMAT T "\HTML.FONTCREATE ~a ~a ~a ~a ~a~%%" FAMILY SIZE FACE ROTATION DEVICE)
   NIL)

(CL:DEFUN \HTML.FONTSAVAILABLE (FAMILY SIZE FACE ROTATION DEVICE)
   "Search for matching fonts for the HTML device"
   (CL:FORMAT T "\HTML.FONTSAVAILABLE ~a ~a ~a ~a ~a~%%" FAMILY SIZE FACE ROTATION DEVICE)
   NIL)

(CL:DEFUN \HTML.INIT-IMAGEDATA (HTMLSTREAM)
   "Finish initializing the stream's IMAGEDATA"

   (* ;; 
 "TODO set the font to the first entry in the FONTS property passed to OPENIMAGESTREAM (IRM p. 26-9)")

   (* ;; "TODO set the LINEFEED to the negative of the font height")

   (with-htmldata (DATA HTMLSTREAM)

          (* ;; "set the margins")

          (CL:SETF (\HTML-LEFT-MARGIN DATA)
                 0)
          (CL:SETF (\HTML-RIGHT-MARGIN DATA)
                 (\HTML-PAGE-WIDTH DATA))
          (CL:SETF (\HTML-TOP-MARGIN DATA)
                 (\HTML-PAGE-HEIGHT DATA))
          (CL:SETF (\HTML-BOTTOM-MARGIN DATA)
                 0)))

(CL:DEFUN \HTML.LINEHEIGHT (STREAM)

   (* ;; "TODO implement this")

   12)

(CL:DEFUN \HTML.SVG-Y (DATA MEDLEY-Y)
   "Return the SVG Y-coordinate for a Medley Y coordinate"
   (- (\HTML-TOP-MARGIN DATA)
      MEDLEY-Y))

(CL:DEFUN \HTML.MAYBE-START-PAGE (DATA STREAM)

   (* ;; "We're going to do output of some sort, so start an SVG stanza if necessary")

   (if (EQ (\HTML-STATE DATA)
           HTML.STATE.BETWEEN-PAGES)
       then (LET [(BACKING (\HTML-BACKING-STREAM DATA))
                  [PAGE-WIDTH (IABS (- (\HTML-RIGHT-MARGIN DATA)
                                       (\HTML-LEFT-MARGIN DATA]
                  (PAGE-HEIGHT (IABS (- (\HTML-BOTTOM-MARGIN DATA)
                                        (\HTML-TOP-MARGIN DATA]
                 (CL:FORMAT BACKING "<svg width=%"~d%" height=%"~d%" viewBox=%"~d ~d ~d ~d%">~%%" 
                        PAGE-WIDTH PAGE-HEIGHT (\HTML-LEFT-MARGIN DATA)
                        (\HTML-BOTTOM-MARGIN DATA)
                        PAGE-WIDTH PAGE-HEIGHT)
                 (HTML.MOVETO STREAM (\HTML-LEFT-MARGIN DATA)
                        (\HTML-TOP-MARGIN DATA))
                 (HTML.OUTPUT-GRAPHICS STREAM))))

(CL:DEFUN \HTMLSTREAM.INIT ()

   (* ;; "Initialize the HTMLSTREAM world")

   (DECLARE (GLOBALVARS \HTMLSTREAM.FDEV IMAGESTREAMTYPES))
   (SETQ \HTMLSTREAM.FDEV (create FDEV
                                 DEVICENAME _ (LIST 'HTML 'DOCUMENT)
                                 CLOSEFILE _ #'NILL
                                 BOUT _ #'NILL))

   (* ;; "update IMAGESTREAMTYPES")

   (PUTASSOC HTML.FONTCREATE.DEVICENAME (MAKE-HTML-IMAGETYPE)
          IMAGESTREAMTYPES))

(DEFMACRO with-htmldata ((DATA-VAR-NAME STREAM)
                         &BODY
                         (BODY DECLS ENV))
   `(LET [(,DATA-VAR-NAME (fetch (STREAM IMAGEDATA) of ,STREAM]
         ,@DECLS
         ,@BODY))

(CL:DEFSTRUCT (HTML.IMAGEDATA (:CONC-NAME \HTML-))
   "Private data for HTMLSTREAMs"
   BACKING-STREAM
   FONT
   CLIPPING-REGION
   SPACE-FACTOR
   IMAGE-OPERATION
   BG-COLOR
   FG-COLOR
   (SCALE 1.0)
   (PAGE-NUM 0)
   (X-POSITION 0)
   (Y-POSITION 0)
   (LEFT-MARGIN 0)
   (TOP-MARGIN 1024)
   (RIGHT-MARGIN 1024)
   (BOTTOM-MARGIN 0)
   (LINEFEED 12)
   (STATE HTML.STATE.BETWEEN-PAGES)
   PAGE-HEIGHT PAGE-WIDTH TITLE)
(DECLARE%: DONTCOPY
  (FILEMAP (NIL (3920 4140 (CHECK-OPEN 3920 . 4140)) (4142 4496 (HTML.BACKCOLOR 4142 . 4496)) (4498 4791
 (HTML.BITBLT 4498 . 4791)) (4793 4976 (HTML.BLTSHADE 4793 . 4976)) (4978 5375 (HTML.BOTTOMMARGIN 4978
 . 5375)) (5377 5465 (HTML.CHARWIDTH 5377 . 5465)) (5467 5820 (HTML.CLIPPINGREGION 5467 . 5820)) (5822
 6400 (HTML.CLOSEFN 5822 . 6400)) (6402 6746 (HTML.COLOR 6402 . 6746)) (6748 6964 (HTML.DRAWCIRCLE 
6748 . 6964)) (6966 7066 (HTML.DRAWCURVE 6966 . 7066)) (7068 7815 (HTML.DRAWELLIPSE 7068 . 7815)) (
7817 8433 (HTML.DRAWLINE 7817 . 8433)) (8435 9252 (HTML.DRAWPOLYGON 8435 . 9252)) (9254 9429 (
HTML.FILLCIRCLE 9254 . 9429)) (9431 10088 (HTML.FILLPOLYGON 9431 . 10088)) (10090 10395 (HTML.FONT 
10090 . 10395)) (10397 10553 (HTML.INCHES-TO-POINTS 10397 . 10553)) (10555 10941 (HTML.LEFTMARGIN 
10555 . 10941)) (10943 11268 (HTML.LINEFEED 10943 . 11268)) (11270 11559 (HTML.MOVETO 11270 . 11559)) 
(11561 11630 (HTML.NEWPAGE 11561 . 11630)) (11632 11989 (HTML.OPERATION 11632 . 11989)) (11991 13393 (
HTML.OUTCHARFN 11991 . 13393)) (13395 14001 (HTML.OUTPUT-GRAPHICS 13395 . 14001)) (14003 14869 (
HTML.OUTPUT-TEXT 14003 . 14869)) (14871 15223 (HTML.RESET 14871 . 15223)) (15225 15619 (
HTML.RIGHTMARGIN 15225 . 15619)) (15621 15934 (HTML.SCALE 15621 . 15934)) (15936 16260 (
HTML.SCALEDBITBLT 15936 . 16260)) (16262 16605 (HTML.SPACEFACTOR 16262 . 16605)) (16607 16699 (
HTML.STRINGWIDTH 16607 . 16699)) (16701 17464 (HTML.TERPRI 16701 . 17464)) (17466 17844 (
HTML.TOPMARGIN 17466 . 17844)) (17846 21408 (HTML.WRITE-PREFACE 17846 . 21408)) (21410 21788 (
HTML.XPOSITION 21410 . 21788)) (21790 22133 (HTML.YPOSITION 21790 . 22133)) (22135 22434 (
MAKE-HTML-IMAGETYPE 22135 . 22434)) (22436 27631 (OPENHTMLSTREAM 22436 . 27631)) (27633 27756 (
\HTML.CHARWIDTH 27633 . 27756)) (27758 27978 (\HTML.END-PAGE 27758 . 27978)) (27980 28558 (
\HTML.FILLCIRCLE 27980 . 28558)) (28560 28759 (\HTML.FONTCREATE 28560 . 28759)) (28761 28980 (
\HTML.FONTSAVAILABLE 28761 . 28980)) (28982 29660 (\HTML.INIT-IMAGEDATA 28982 . 29660)) (29662 29746 (
\HTML.LINEHEIGHT 29662 . 29746)) (29748 29895 (\HTML.SVG-Y 29748 . 29895)) (29897 30870 (
\HTML.MAYBE-START-PAGE 29897 . 30870)) (30872 31369 (\HTMLSTREAM.INIT 30872 . 31369)) (31371 31603 (
with-htmldata 31371 . 31603)))))
STOP
